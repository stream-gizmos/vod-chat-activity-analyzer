{% extends "base-layout.html" %}

{% block scripts %}
    <script type="text/javascript" src="{{ url_for("static", filename="plotly-2.32.0.min.js") }}" defer></script>
    <script type="text/javascript" src="{{ url_for("static", filename="twitch-embed-v1.js") }}" defer></script>
    <script type="text/javascript" src="https://www.youtube.com/player_api"></script>
    <script type="text/javascript" src="{{ url_for("static", filename="scripts.js") }}" defer></script>
{% endblock %}

{% block content %}
    <h1>Chat Activity Statistics</h1>

    {% for alias, graph_data in graphs | dictsort %}
        <p id="vod_{{ alias }}">
            {% if graph_data.url %}
                <b>{{ loop.index0 + 1 }}. VOD URL</b>:
                <a href="{{ graph_data.url }}" target="_blank">
                    {{ graph_data.caption or graph_data.url }}
                </a>
            {% else %}
                <b>{{ loop.index0 + 1 }}. {{ graph_data.caption }}</b>
            {% endif %}
        </p>
        <p>
            {% if graph_data.platform %}
                <button type="button" onclick="toggleVisibility('player-container-{{ alias | safe }}')">Show the video</button>
            {% endif %}
        </p>

        {% if graph_data.platform %}
            <div id="player-container-{{ alias }}" class="hidden">
                {% if graph_data.platform == "twitch" %}
                    <div id="twitch-player-{{ alias }}" class="twitch-player"></div>
                {% endif %}
                {% if graph_data.platform == "youtube" %}
                    <div id="youtube-player-{{ alias }}" class="youtube-player"></div>
                {% endif %}

                <p>(Shift+Click on the chart to seek the video to this time)</p>
            </div>
        {% endif %}

        <div id="{{ alias }}"></div>
    {% endfor %}

    <script>
        const plotlyConfig = {
            modeBarButtonsToRemove: ['select', 'lasso2d'],
        }

        document.addEventListener("DOMContentLoaded", () => {
            {% for alias, graph_data in graphs.items() %}
                (function () {
                    const {{ alias }} = {{ graph_data.json | safe }}
                    Plotly.newPlot("{{ alias }}", {{ alias }}.data, {{ alias }}.layout, plotlyConfig)
                })();

                {% if graph_data.platform == "twitch" and graph_data.vod_id %}
                    (function () {
                        const vodId = "{{ graph_data.vod_id | safe }}"
                        const player = buildTwitchPlayer("twitch-player-{{ alias }}", vodId)

                        const $plot = document.getElementById("{{ alias }}")
                        onPointClick($plot, seconds => player.seek(seconds))
                    })();
                {% endif %}
                {% if graph_data.platform == "youtube" and graph_data.vod_id %}
                    (async function () {
                        const vodId = "{{ graph_data.vod_id | safe }}"
                        const player = await buildYoutubePlayer("youtube-player-{{ alias }}", vodId)

                        const $plot = document.getElementById("{{ alias }}")
                        onPointClick($plot, seconds => player.seekTo(seconds))
                    })();
                {% endif %}
            {% endfor %}
        });
    </script>
{% endblock %}
